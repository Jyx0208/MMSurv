# MMSurv å¤šæ¨¡æ€ç”Ÿå­˜åˆ†æé¡¹ç›®ä½¿ç”¨æŒ‡å—

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

MMSurvæ˜¯ä¸€ä¸ªåŸºäºå¤šæ¨¡æ€å¤šå®ä¾‹å­¦ä¹ ï¼ˆMILï¼‰çš„ç”Ÿå­˜é¢„æµ‹é¡¹ç›®ï¼Œä¸“é—¨ç”¨äºç™Œç—‡æ‚£è€…çš„ç”Ÿå­˜åˆ†æã€‚è¯¥é¡¹ç›®æ•´åˆäº†ä»¥ä¸‹å¤šç§å…ˆè¿›æ¨¡å‹ï¼š

- **AMIL** (Attention-based Multiple Instance Learning)
- **DeepSet** (æ·±åº¦é›†åˆå­¦ä¹ )
- **DeepAttnMISL** (æ·±åº¦æ³¨æ„åŠ›å¤šå®ä¾‹å­¦ä¹ )
- **PORPOISE** (ç—…ç†ä¸åŸºå› ç»„å¤šæ¨¡æ€èåˆæ¨¡å‹)
- **MCAT** (å¤šæ¨¡æ€å…±æ³¨æ„åŠ›Transformer)
- **MOTCat** (å¤šæ¨¡æ€æœ€ä¼˜ä¼ è¾“å…±æ³¨æ„åŠ›Transformer)

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- æ•´åˆå…¨åˆ‡ç‰‡æ•°å­—ç—…ç†å›¾åƒ(WSI)å’ŒåŸºå› æ•°æ®
- æ”¯æŒç¦»æ•£æ—¶é—´ç”Ÿå­˜é¢„æµ‹
- å¤šæ¨¡æ€æ•°æ®èåˆåˆ†æ
- 5æŠ˜äº¤å‰éªŒè¯è¯„ä¼°

---

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 (æ¨è)
- **GPU**: NVIDIAæ˜¾å¡ (æµ‹è¯•ç¯å¢ƒ: RTX 4090)
- **å†…å­˜**: å»ºè®®16GBä»¥ä¸Š
- **å­˜å‚¨**: å»ºè®®50GBä»¥ä¸Šå¯ç”¨ç©ºé—´

### è½¯ä»¶ä¾èµ–
- **Python**: 3.10
- **PyTorch**: 2.3.0
- **CUDA**: å¯¹åº”PyTorchç‰ˆæœ¬çš„CUDAæ”¯æŒ
- **Conda**: ç”¨äºç¯å¢ƒç®¡ç†

### PythonåŒ…ä¾èµ–
```bash
# æ ¸å¿ƒä¾èµ–
torch==2.3.0
numpy==1.23.4
pandas==1.4.3
h5py
scikit-learn
scikit-survival
tensorboardx
pot==0.9.3  # Python Optimal Transport
```

---

## ğŸ“¦ å®‰è£…æ­¥éª¤

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/ezgiogulmus/MMSurv.git
cd MMSurv
```

### 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
```bash
# åˆ›å»ºcondaç¯å¢ƒ
conda create -n mmsurv python=3.10 -y
conda activate mmsurv

# å‡çº§pip
pip install --upgrade pip
```

### 3. å®‰è£…ä¾èµ–
```bash
# å®‰è£…é¡¹ç›®åŠå…¶ä¾èµ–
pip install -e .
```

### 4. éªŒè¯å®‰è£…
```bash
# æ£€æŸ¥PyTorchæ˜¯å¦æ”¯æŒGPU
python -c "import torch; print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
```

---

## ğŸš€ è¿è¡Œæ–¹å¼

### å¿«é€Ÿå¼€å§‹ï¼ˆä½¿ç”¨è™šæ‹Ÿæ•°æ®ï¼‰

#### æ­¥éª¤1: ç”Ÿæˆè™šæ‹Ÿæ•°æ®
```bash
cd mmsurv
python create_dummydata.py
```
- ç”Ÿæˆ30ä¸ªæ‚£è€…çš„è™šæ‹Ÿæ•°æ®
- åŒ…å«RNAã€DNAã€CNVåŸºå› æ•°æ®å’Œç—…ç†å›¾åƒç‰¹å¾
- è‡ªåŠ¨åˆ›å»ºè®­ç»ƒ/éªŒè¯/æµ‹è¯•æ•°æ®åˆ†å‰²

#### æ­¥éª¤2: ä¿å­˜èšç±»ID
```bash
python save_cluster_ids.py dummy --patch_dir ./dummy_data/coords_dir/
```
- å¯¹ç—…ç†å›¾åƒè¡¥ä¸è¿›è¡ŒK-meansèšç±»
- ç”Ÿæˆèšç±»æ ‡è¯†æ–‡ä»¶ç”¨äºåç»­è®­ç»ƒ

#### æ­¥éª¤3: è¿è¡Œæ¨¡å‹è®­ç»ƒ
```bash
# åŸºæœ¬è¿è¡Œå‘½ä»¤
python main.py --data_name dummy --feats_dir ./dummy_data/feats_dir/ --omics rna,dna,cnv --model_type porpoise
```

### å®Œæ•´å‚æ•°è¯´æ˜

#### æ•°æ®ç›¸å…³å‚æ•°
```bash
--data_name           # æ•°æ®é›†åç§° (å¿…éœ€)
--feats_dir           # ç‰¹å¾æ–‡ä»¶ç›®å½• (å¿…éœ€)
--dataset_dir         # æ•°æ®é›†CSVæ–‡ä»¶ç›®å½• (é»˜è®¤: ./datasets_csv)
--results_dir         # ç»“æœä¿å­˜ç›®å½• (é»˜è®¤: ./results)
--split_dir           # æ•°æ®åˆ†å‰²ç›®å½• (é»˜è®¤: ./splits)
```

#### æ¨¡å‹å‚æ•°
```bash
--model_type          # æ¨¡å‹ç±»å‹:
                      # deepset, amil, deepattnmisl, mcat, motcat, porpoise, cmta
--mode                # æ¨¡æ€é€‰æ‹©:
                      # omic(ä»…åŸºå› ), path(ä»…ç—…ç†), pathomic(å¤šæ¨¡æ€)
--omics               # åŸºå› æ•°æ®ç±»å‹: rna,dna,cnv
--fusion              # èåˆæ–¹å¼: None, concat, bilinear
--n_classes           # ç”Ÿå­˜æ—¶é—´åˆ†ç±»æ•° (é»˜è®¤: 4)
```

#### è®­ç»ƒå‚æ•°
```bash
--max_epochs          # æœ€å¤§è®­ç»ƒè½®æ•° (é»˜è®¤: 20)
--batch_size          # æ‰¹æ¬¡å¤§å° (é»˜è®¤: 1)
--lr                  # å­¦ä¹ ç‡ (é»˜è®¤: 2e-4)
--bag_loss            # æŸå¤±å‡½æ•°: nll_surv, cox_surv, ce_surv
--k                   # äº¤å‰éªŒè¯æŠ˜æ•° (é»˜è®¤: 5)
--seed                # éšæœºç§å­ (é»˜è®¤: 1)
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶
```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶ config.json
{
    "model_type": "porpoise",
    "mode": "pathomic",
    "omics": "rna,dna,cnv",
    "max_epochs": 50,
    "lr": 1e-4
}

# ä½¿ç”¨é…ç½®æ–‡ä»¶è¿è¡Œ
python run_mmsurv.py --run_config_file config.json --data_name dummy --feats_dir ./dummy_data/feats_dir/
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: å¤šæ¨¡æ€ç”Ÿå­˜é¢„æµ‹
```bash
# ä½¿ç”¨PORPOISEæ¨¡å‹è¿›è¡Œå¤šæ¨¡æ€åˆ†æ
python main.py \
    --data_name dummy \
    --feats_dir ./dummy_data/feats_dir/ \
    --omics rna,dna,cnv \
    --model_type porpoise \
    --mode pathomic \
    --max_epochs 30 \
    --bag_loss nll_surv
```

### ç¤ºä¾‹2: ä»…ä½¿ç”¨ç—…ç†å›¾åƒ
```bash
# ä»…ä½¿ç”¨ç—…ç†æ•°æ®è¿›è¡Œç”Ÿå­˜é¢„æµ‹
python main.py \
    --data_name dummy \
    --feats_dir ./dummy_data/feats_dir/ \
    --model_type amil \
    --mode path \
    --max_epochs 25
```

### ç¤ºä¾‹3: ä»…ä½¿ç”¨åŸºå› æ•°æ®
```bash
# ä»…ä½¿ç”¨åŸºå› æ•°æ®è¿›è¡Œç”Ÿå­˜é¢„æµ‹
python main.py \
    --data_name dummy \
    --omics rna,dna \
    --model_type deepset \
    --mode omic \
    --max_epochs 20
```

### é¢„æœŸè¾“å‡º
è®­ç»ƒå®Œæˆåï¼Œåœ¨`results/`ç›®å½•ä¸‹ä¼šç”Ÿæˆï¼š
- **æ¨¡å‹æ–‡ä»¶**: è®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡
- **æ€§èƒ½æŒ‡æ ‡**: C-indexã€å‡†ç¡®ç‡ç­‰
- **å®éªŒæ—¥å¿—**: è®­ç»ƒè¿‡ç¨‹è®°å½•
- **å¯è§†åŒ–ç»“æœ**: ç”Ÿå­˜æ›²çº¿ã€æ··æ·†çŸ©é˜µç­‰

---

## â— å¸¸è§é—®é¢˜

### 1. CUDAå†…å­˜ä¸è¶³
**é”™è¯¯**: `CUDA out of memory`
**è§£å†³**:
- å‡å°`--batch_size`å‚æ•°
- ä½¿ç”¨`--model_size_wsi small`å’Œ`--model_size_omic small`
- å¢åŠ æ¢¯åº¦ç´¯ç§¯æ­¥æ•°`--gc 64`

### 2. æ•°æ®æ ¼å¼é”™è¯¯
**é”™è¯¯**: `File not found` æˆ– `KeyError`
**è§£å†³**:
- ç¡®ä¿ç‰¹å¾æ–‡ä»¶è·¯å¾„æ­£ç¡®`--feats_dir`
- æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
- éªŒè¯åŸºå› æ•°æ®åˆ—åæ ¼å¼

### 3. æ¨¡å‹è®­ç»ƒä¸æ”¶æ•›
**è§£å†³**:
- è°ƒæ•´å­¦ä¹ ç‡`--lr` (å»ºè®®1e-4åˆ°1e-3)
- å¢åŠ è®­ç»ƒè½®æ•°`--max_epochs`
- å°è¯•ä¸åŒçš„æŸå¤±å‡½æ•°`--bag_loss`

### 4. ä¾èµ–åŒ…å†²çª
**è§£å†³**:
```bash
# é‡æ–°åˆ›å»ºå¹²å‡€ç¯å¢ƒ
conda create -n mmsurv_clean python=3.10 -y
conda activate mmsurv_clean
pip install --upgrade pip
pip install -e .
```

### 5. è™šæ‹Ÿæ•°æ®ç”Ÿæˆå¤±è´¥
**è§£å†³**:
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
- æ£€æŸ¥ç›®å½•æƒé™
- æ‰‹åŠ¨åˆ›å»ºå¿…è¦ç›®å½•: `mkdir -p dummy_data/feats_dir dummy_data/coords_dir`

---

## ğŸ“ é¡¹ç›®ç»“æ„è¯´æ˜

```
MMSurv/
â”œâ”€â”€ mmsurv/                    # ä¸»è¦ä»£ç ç›®å½•
â”‚   â”œâ”€â”€ models/               # æ¨¡å‹å®ç°
â”‚   â”‚   â”œâ”€â”€ model_porpoise.py # PORPOISEæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ model_mcat.py     # MCATæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ model_motcat.py   # MOTCatæ¨¡å‹
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ datasets/             # æ•°æ®é›†å¤„ç†
â”‚   â”‚   â””â”€â”€ dataset_survival.py
â”‚   â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ utils.py
â”‚   â”‚   â””â”€â”€ core_utils.py
â”‚   â”œâ”€â”€ main.py               # ä¸»è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ arguments.py          # å‚æ•°é…ç½®
â”‚   â”œâ”€â”€ create_dummydata.py   # è™šæ‹Ÿæ•°æ®ç”Ÿæˆ
â”‚   â””â”€â”€ save_cluster_ids.py   # èšç±»IDä¿å­˜
â”œâ”€â”€ datasets_csv/             # CSVæ•°æ®æ–‡ä»¶
â”œâ”€â”€ splits/                   # æ•°æ®åˆ†å‰²æ–‡ä»¶
â”œâ”€â”€ results/                  # å®éªŒç»“æœ
â”œâ”€â”€ dummy_data/               # è™šæ‹Ÿæ•°æ®
â”‚   â”œâ”€â”€ feats_dir/           # ç‰¹å¾æ–‡ä»¶
â”‚   â””â”€â”€ coords_dir/          # åæ ‡æ–‡ä»¶
â”œâ”€â”€ run_mmsurv.py            # è¿è¡Œè„šæœ¬
â””â”€â”€ setup.py                 # å®‰è£…é…ç½®
```

---

## ğŸ“ åç»­å­¦ä¹ å»ºè®®

### 1. æ·±å…¥ç†è§£æ¨¡å‹åŸç†
- **é˜…è¯»è®ºæ–‡**: é¡¹ç›®ä¸»é¡µæä¾›äº†ç›¸å…³è®ºæ–‡é“¾æ¥
- **æ¨¡å‹å¯¹æ¯”**: å°è¯•ä¸åŒæ¨¡å‹äº†è§£å„è‡ªç‰¹ç‚¹
- **å‚æ•°è°ƒä¼˜**: ç³»ç»Ÿæ€§è°ƒæ•´è¶…å‚æ•°

### 2. å‡†å¤‡çœŸå®æ•°æ®
```bash
# æ•°æ®é¢„å¤„ç†æµç¨‹
1. ä½¿ç”¨CLAMåº“æå–ç—…ç†å›¾åƒç‰¹å¾
2. å‡†å¤‡åŸºå› è¡¨è¾¾æ•°æ® (RNA, DNA, CNV)
3. æ ¼å¼åŒ–ç”Ÿå­˜æ•°æ® (ç”Ÿå­˜æ—¶é—´+äº‹ä»¶çŠ¶æ€)
4. åˆ›å»ºæ•°æ®åˆ†å‰²æ–‡ä»¶
```

### 3. æ¨¡å‹æ”¹è¿›å’Œæ‰©å±•
- **è‡ªå®šä¹‰æ¨¡å‹**: åœ¨`models/`ç›®å½•ä¸‹æ·»åŠ æ–°æ¨¡å‹
- **æŸå¤±å‡½æ•°**: ä¿®æ”¹æˆ–æ–°å¢æŸå¤±å‡½æ•°
- **ç‰¹å¾å·¥ç¨‹**: æ”¹è¿›ç‰¹å¾æå–æ–¹æ³•

### 4. æ€§èƒ½ä¼˜åŒ–
- **GPUåŠ é€Ÿ**: ä¼˜åŒ–æ•°æ®åŠ è½½å’Œè®­ç»ƒæµç¨‹
- **åˆ†å¸ƒå¼è®­ç»ƒ**: æ”¯æŒå¤šGPUå¹¶è¡Œè®­ç»ƒ
- **æ¨¡å‹å‹ç¼©**: åº”ç”¨é‡åŒ–æˆ–å‰ªææŠ€æœ¯

### 5. å‚ä¸è´¡çŒ®
- **æŠ¥å‘Šé—®é¢˜**: åœ¨GitHub Issuesä¸­æäº¤bug
- **åŠŸèƒ½å»ºè®®**: æå‡ºæ–°ç‰¹æ€§éœ€æ±‚
- **ä»£ç è´¡çŒ®**: æäº¤Pull Request

### 6. ç›¸å…³å·¥å…·å­¦ä¹ 
- **CLAM**: ç—…ç†å›¾åƒç‰¹å¾æå–
- **scikit-survival**: ç”Ÿå­˜åˆ†æå·¥å…·åŒ…
- **Python Optimal Transport**: æœ€ä¼˜ä¼ è¾“ç®—æ³•

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨é¡¹ç›®ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹é¡¹ç›®çš„GitHub Issues
2. é˜…è¯»ç›¸å…³è®ºæ–‡äº†è§£ç®—æ³•ç»†èŠ‚
3. å‚è€ƒé¡¹ç›®ä¸­çš„ç¤ºä¾‹ä»£ç 
4. æ£€æŸ¥æ•°æ®æ ¼å¼å’Œå‚æ•°é…ç½®

*ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼*

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2025-09-07*
*é¡¹ç›®ç‰ˆæœ¬: åŸºäºGitHubæœ€æ–°ç‰ˆæœ¬*